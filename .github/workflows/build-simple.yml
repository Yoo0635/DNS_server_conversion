name: Build Cross Platform

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install PyInstaller
    
    - name: Build macOS app
      run: |
        python -m PyInstaller NetworkOptimizer-macOS.spec --noconfirm
    
    - name: Create macOS archive
      run: |
        zip -r NetworkOptimizer-macOS-v3.0.2.zip dist/NetworkOptimizer-macOS.app
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v3
      with:
        name: macos-build
        path: NetworkOptimizer-macOS-v3.0.2.zip

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install PyInstaller
    
    - name: Build Windows app
      run: |
        python -m PyInstaller NetworkOptimizer-Windows.spec --noconfirm
    
    - name: Create Windows archive
      run: |
        Compress-Archive -Path "dist\NetworkOptimizer-Windows" -DestinationPath "NetworkOptimizer-Windows-v3.0.2.zip"
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v3
      with:
        name: windows-build
        path: NetworkOptimizer-Windows-v3.0.2.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install PyInstaller
    
    - name: Build Linux app
      run: |
        python -m PyInstaller NetworkOptimizer-Linux.spec --noconfirm
        chmod +x dist/NetworkOptimizer-Linux
    
    - name: Create Linux archive
      run: |
        tar -czf NetworkOptimizer-Linux-v3.0.2.tar.gz -C dist NetworkOptimizer-Linux
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v3
      with:
        name: linux-build
        path: NetworkOptimizer-Linux-v3.0.2.tar.gz

  release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: ./artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/macos-build/NetworkOptimizer-macOS-v3.0.2.zip
          artifacts/windows-build/NetworkOptimizer-Windows-v3.0.2.zip
          artifacts/linux-build/NetworkOptimizer-Linux-v3.0.2.tar.gz
        body: |
          ğŸŒ Network Optimizer v3.0.2 - í¬ë¡œìŠ¤ í”Œë«í¼ ë¦´ë¦¬ì¦ˆ
          
          âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥:
          - ì•ˆì •ì ì¸ ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
          - ë¬´í•œ ì°½ ìƒì„± ë¬¸ì œ í•´ê²°
          - ì™„ì „ ë…ë¦½ ì‹¤í–‰ (Python ì„¤ì¹˜ ë¶ˆí•„ìš”)
          - ëª¨ë“  DNS ê¸°ëŠ¥ ì™„ë²½ ì§€ì›
          
          ğŸš€ ì‚¬ìš©ë²•:
          1. ë³¸ì¸ì˜ ìš´ì˜ì²´ì œì— ë§ëŠ” íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          2. ì••ì¶• í•´ì œ
          3. ì‹¤í–‰ íŒŒì¼ ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‹¤í–‰
          
          ğŸ“± ì§€ì› í”Œë«í¼:
          - Windows 10 ì´ìƒ
          - macOS 10.13 ì´ìƒ
          - Linux (Ubuntu 18.04 ì´ìƒ)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
